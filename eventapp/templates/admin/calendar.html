{% extends 'admin/base.html' %}

{% block body %}
<div class="container">
  <h2>All Bookings Calendar</h2>
  <div id="calendar"></div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.2/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.2/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.2/locales-all.min.js"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />

<script>
  // --- tiny on-page debug so you can see logs ---
  (function setupDebug(){
    const box = document.createElement('pre');
    box.id = 'debugLog';
    box.style.cssText = 'position:fixed;left:0;right:0;bottom:0;max-height:35vh;overflow:auto;margin:0;background:#111;color:#0f0;padding:8px;font:12px/1.4 monospace;z-index:99999;opacity:.95';
    box.textContent = 'Debug log:\n';
    document.addEventListener('DOMContentLoaded', ()=> document.body.appendChild(box));
    window.__debug = function(){
      const msg = Array.from(arguments).map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
      console.log.apply(console, arguments);
      box.textContent += msg + '\n';
    };
    window.onerror = function(msg, src, line, col){
      __debug('JS ERROR:', msg, 'at', src, line + ':' + col);
    };
  })();

  document.addEventListener('DOMContentLoaded', function () {
    __debug('DOMContentLoaded');

    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) { __debug('No #calendar element'); return; }

    // Parse booking.start into a LOCAL time Date
    function parseStart(val) {
      if (val == null) return null;
      const s = String(val).trim().replace(/\.\d+$/, ''); // drop microseconds

      // CASE 1: RFC1123 with GMT/UTC, e.g. "Fri, 27 Sep 2024 16:00:00 GMT"
      // If your data uses this format but represents *local* time, IGNORE the "GMT" tag and build a local Date.
      const rfc = s.match(/^\w{3}, (\d{2}) (\w{3}) (\d{4}) (\d{2}):(\d{2})(?::(\d{2}))? (GMT|UTC)$/i);
      if (rfc) {
        const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
        const d = new Date(+rfc[3], months[rfc[2]], +rfc[1], +rfc[4], +rfc[5], +(rfc[6]||0)); // LOCAL
        __debug('mode:rfc1123-as-local', s, '=>', d.toString());
        return d;
      }

      // CASE 2: Timezone-aware ISO strings (ends with Z or ±HH:MM) — treat correctly
      if (/Z$|[+-]\d{2}:\d{2}$/.test(s)) {
        const d = new Date(s);
        __debug('mode:tz-aware', s, '=>', d.toString());
        return d;
      }

      // CASE 3: Naive DB formats -> build as LOCAL
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})(?::(\d{2}))?$/);
      if (m) {
        const d = new Date(+m[1], +m[2]-1, +m[3], +m[4], +m[5], +(m[6]||0));
        __debug('mode:naive-local', s, '=>', d.toString());
        return d;
      }

      // CASE 4: Date-only -> let FC handle as all-day
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
        __debug('mode:all-day', s, '=> (all-day)');
        return s;
      }

      // Fallback
      const d = new Date(s);
      __debug('mode:fallback-Date', s, '=>', d.toString());
      return d;
    }

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      timeZone: 'local', // keep it simple

      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },

      eventTimeFormat: { hour: '2-digit', minute: '2-digit' },

      events: function(fetchInfo, success, failure) {
        const url = `/api/bookings?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`;
        __debug('Fetching:', url);

        fetch(url)
          .then(r => { __debug('Fetch status:', r.status); if (!r.ok) throw new Error('Network ' + r.status); return r.json(); })
          .then(data => {
            const list = Array.isArray(data) ? data : [];
            const events = [];

            for (const b of list) {
              if (!b || !b.start) { __debug('skip: no start'); continue; }
              const startVal = parseStart(b.start);
              __debug('start in/out ->', b.start, '=>', (startVal instanceof Date ? startVal.toString() : String(startVal)));
              const e = {
                id: b.id,
                title: b.title,
                start: startVal,
                description:
                  `Amount Paid: ${b.amount_paid} ${b.currency}, ` +
                  `Tickets: ${b.tickets}, Order ID: ${b.order_id}, ` +
                  `Phone: ${b.phone || 'N/A'}, Status: ${b.status}, Email: ${b.email}`
              };
              if (b.end) e.end = parseStart(b.end);
              events.push(e);
            }

            __debug('Mapped events:', events.length);
            success(events);
          })
          .catch(err => { __debug('Fetch/mapping error:', err && err.message ? err.message : String(err)); failure(err); });
      },

      eventClick: function(info) {
        window.location.href = `/admin/booking/${info.event.id}`;
      },

      eventDidMount: function(info) {
        if (typeof tippy === 'function') {
          tippy(info.el, {
            content: info.event.extendedProps.description,
            placement: 'top',
            theme: 'light',
            trigger: 'mouseenter',
            arrow: true,
            duration: [200, 200]
          });
        }
      }
    });

    __debug('Rendering calendar…');
    calendar.render();
    __debug('Calendar rendered');
  });
</script>
{% endblock %}
