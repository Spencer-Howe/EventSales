{% extends 'admin/base.html' %}

{% block body %}
<div class="container">
  <h2>All Bookings Calendar</h2>
  <div id="calendar"></div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.2/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.2/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.2/locales-all.min.js"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    // Parse booking.start into a LOCAL time Date
    function parseStart(val) {
      if (val == null) return null;
      const s = String(val).trim().replace(/\.\d+$/, ''); // drop microseconds

      // RFC1123 with GMT/UTC, e.g. "Fri, 27 Sep 2024 16:00:00 GMT" -> treat as LOCAL clock time
      const rfc = s.match(/^\w{3}, (\d{2}) (\w{3}) (\d{4}) (\d{2}):(\d{2})(?::(\d{2}))? (GMT|UTC)$/i);
      if (rfc) {
        const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
        return new Date(+rfc[3], months[rfc[2]], +rfc[1], +rfc[4], +rfc[5], +(rfc[6]||0)); // LOCAL
      }

      // Timezone-aware ISO -> let Date handle correctly
      if (/Z$|[+-]\d{2}:\d{2}$/.test(s)) return new Date(s);

      // Naive DB formats -> build LOCAL Date
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})(?::(\d{2}))?$/);
      if (m) return new Date(+m[1], +m[2]-1, +m[3], +m[4], +m[5], +(m[6]||0));

      // Date-only -> treat as all-day
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

      // Fallback
      return new Date(s);
    }

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      timeZone: 'local',

      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },

      eventTimeFormat: { hour: '2-digit', minute: '2-digit' },

      events: function(fetchInfo, success, failure) {
        const url = `/api/bookings?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`;
        fetch(url)
          .then(r => { if (!r.ok) throw new Error('Network ' + r.status); return r.json(); })
          .then(data => {
            const list = Array.isArray(data) ? data : [];
            const events = [];

            for (const b of list) {
              if (!b || !b.start) continue;
              const e = {
                id: b.id,
                title: b.title,
                start: parseStart(b.start),
                description:
                  `Amount Paid: ${b.amount_paid} ${b.currency}, ` +
                  `Tickets: ${b.tickets}, Order ID: ${b.order_id}, ` +
                  `Phone: ${b.phone || 'N/A'}, Status: ${b.status}, Email: ${b.email}`
              };
              if (b.end) e.end = parseStart(b.end);
              events.push(e);
            }

            success(events);
          })
          .catch(failure);
      },

      eventClick: function(info) {
        window.location.href = `/admin/booking/${info.event.id}`;
      },

      eventDidMount: function(info) {
        if (typeof tippy === 'function') {
          tippy(info.el, {
            content: info.event.extendedProps.description,
            placement: 'top',
            theme: 'light',
            trigger: 'mouseenter',
            arrow: true,
            duration: [200, 200]
          });
        }
      }
    });

    calendar.render();
  });
</script>
{% endblock %}
