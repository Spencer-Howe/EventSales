<!-- templates/select_tickets.html -->
{% extends "base.html" %}

{% block title %}Select Tickets{% endblock %}

{% block content %}
<body>
{% if processing %}
    <h1>Payment Received - Finalizing Booking</h1>
    <div class="alert alert-info" role="alert">
        <h4 class="alert-heading">Payment Confirmed!</h4>
        <p>Your payment has been successfully received and is being processed.</p>
        <p>Order ID: <strong>{{ order_id }}</strong></p>
        <hr>
        <p class="mb-0">Please refresh this page in a few moments to see your complete receipt and QR code.</p>
    </div>
    <script>
        // Auto-refresh every 5 seconds until booking is processed
        setTimeout(function() {
            location.reload();
        }, 5000);
    </script>
{% else %}
    <h1>Payment Receipt</h1>
    <p><strong>Name:</strong> {{name}}</p>
    <p><strong>Email:</strong> {{email}}</p>
    <p>Order ID: {{ order_id }}</p>
    <p>Total Amount: {{ amount }}</p>
    <p>Currency: {{ currency }}</p>
    <p>Status: {{ status }}</p>
    <p>Time slot: {{time_slot}}</p>
    <p>Number of Tickets: {{ tickets }}</p>
    <div class="mb-3">
        <a href="{{ url_for('views.sign_waiver', order_id=order_id) }}" class="btn btn-primary">Please Complete Registration</a>
    </div>
    <!-- QR Code for Check-in -->
    <div class="text-center mb-4" style="border: 2px dashed #007bff; padding: 20px; border-radius: 10px; background-color: #f8f9fa;">
        <h3 style="color: #007bff; margin-bottom: 15px;">ðŸ“± Quick Check-In</h3>
        <p><strong>Show this QR code when you arrive for instant check-in!</strong></p>
        {% if qr_code %}
            <img src="{{ qr_code }}" alt="Check-in QR Code" style="width: 200px; height: 200px; margin: 10px;">
        {% endif %}
        
        <!-- Mobile-friendly download options -->
        <div style="margin: 15px 0;">
            <a href="{{ url_for('views.download_qr_code', order_id=order_id) }}" 
               class="btn btn-success btn-sm" 
               style="margin: 5px; padding: 10px 20px; background-color: #28a745; border: none; color: white; text-decoration: none; border-radius: 5px; display: inline-block;"
               download>
                ðŸ“¥ Download QR Code
            </a>
            <button onclick="shareQRCode()" 
                    class="btn btn-info btn-sm" 
                    style="margin: 5px; padding: 10px 20px; background-color: #17a2b8; border: none; color: white; border-radius: 5px;"
                    id="shareBtn">
                ðŸ“¤ Share QR Code
            </button>
        </div>
        
        <p style="margin-top: 10px; font-size: 0.9rem; color: #6c757d;">
            Or visit: <code>{{ checkin_url }}</code>
        </p>
    </div>

    <script>
    async function shareQRCode() {
        const shareBtn = document.getElementById('shareBtn');
        
        // Check if Web Share API is supported
        if (navigator.share) {
            try {
                // Fetch the QR code image as blob
                const response = await fetch('{{ url_for("views.download_qr_code", order_id=order_id) }}');
                const blob = await response.blob();
                const file = new File([blob], 'qr_code_{{ order_id }}.png', { type: 'image/png' });
                
                await navigator.share({
                    title: 'Check-in QR Code - Howe Ranch',
                    text: 'My check-in QR code for Howe Ranch visit',
                    files: [file]
                });
            } catch (error) {
                // Fallback to download if sharing fails
                fallbackDownload();
            }
        } else {
            // Fallback for browsers that don't support Web Share API
            fallbackDownload();
        }
    }

    function fallbackDownload() {
        // Create a temporary link and trigger download
        const link = document.createElement('a');
        link.href = '{{ url_for("views.download_qr_code", order_id=order_id) }}';
        link.download = 'qr_code_{{ order_id }}.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    </script>

    <hr>

    <h2>Thank You & Important Visit Information</h2>
{% endif %}

{% if not processing %}
<h2 style="margin-top: 30px;">Thank You & Important Visit Information</h2>
<p>Thank you for purchasing passes to the Mini Moos experience at Howe Ranch! Our miniature Highland cows and their barn friends are excited to show you the magical place they call home:</p>
<p><strong>22053 Highland St<br>Wildomar, CA 92595</strong></p>
<p>To be compliant with our neighborhood's no impact policies and liability regulations, and ensure a safe and enjoyable experience for the animals and you, we must ask that you please confirm that you have reviewed the visit guidelines below, as posted on our website:</p>

<h3 style="color: #d9534f; margin-top: 25px;">Arrival Guidelines - No Early Arrivals</h3>
<ul style="padding-left: 20px;">
    <li><strong>EARLY ARRIVALS STRICTLY PROHIBITED:</strong> Guests must not arrive before the event start time. Entry is strictly prohibited before your scheduled time slot due to farm liability management guidelines, which includes moving animals across the parking access area. Early arrivals disrupt operations, compromise safety while moving animals, and will not be accommodated. You will not miss anything by arriving after your scheduled time. We recommend Montage Brothers and Starbucks coffee houses down the street if you arrive in the area early.</li>
    <br>
    <li><strong>PRIVATE ROAD LAWS:</strong> Stopping or staging on the private farm road is strictly prohibited. Strict 15 MPH speed limit on the monitored, unpaved street leading to Howe Ranch as postedâ€” speeding will result in loss of your pass(es).</li>
</ul>

<h3 style="color: #2e6c80; margin-top: 25px;">Animal Interactions & Safety</h3>
<ul style="padding-left: 20px;">
    <li><strong>NO DOGS:</strong> For the safety of our animals and guests, our farm cannot accommodate dogs. Most of our animals are prey species, their reactions would make the encounter unsafe for all, and we have trained livestock guardians to protect from unknown canines on site.</li>
    <br>
    <li><strong>SAFETY:</strong> Sunscreen, hat, and closed-toed shoes. Important: Bring water for hydration.</li>
    <br>
    <li><strong>SUPERVISED ONLY:</strong> For your safety and the safety of our animals, please do not approach any animals until staff has reviewed safety guidelines with you and is present. Children must be supervised by your group at all time.</li>
</ul>
<p style="margin-top: 15px;">If you arrive and do not see a staff member immediately, please call or text <strong>(424) 219-4212</strong> and remain in the designated waiting area. We might be assisting other guests or preparing animals for your experience.</p>

<h3 style="color: #2e6c80; margin-top: 25px;">Transferable Only â€” No Refunds or Reschedules</h3>
<p>The moment your experience is booked, resources are reserved and your time slot is blocked from other visitors. Booked experiences are transferable to other guests in your network, but not refundable, and cannot be rescheduled. Because our team is fully dedicated to caring for the animals and hosting scheduled guests, requests for exceptions cannot be accommodated and will not receive a response. If you transfer your experience, we must receive the guest's name prior to arrival.</p>

<p style="margin-top: 25px;">We're so excited to welcome you to the ranch and share the magic of our animals and their farm with you. Thank you for helping us keep our doors open by being a thoughtful steward of small farm experiences in our beautiful area.</p>
<p style="margin-top: 15px;">When you arrive, turn left at the Parking Sign and show your QR Pass to the gatekeeper, who will direct you to the parking area. Have fun!</p>

<p>Warmly,<br>Spencer Howe</p>
{% endif %}


</body>

    {% endblock %}
